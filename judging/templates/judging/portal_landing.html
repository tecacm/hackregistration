{% extends 'base.html' %}
{% load i18n %}

{% block head %}
    {{ block.super }}
    {% include 'components/import_qr_scanner.html' %}
{% endblock %}

{% block subtitle %}{% translate "Start scoring" %}{% endblock %}

{% block content %}
<div class="d-flex flex-column gap-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-3">
            <div>
                <div class="text-uppercase small fw-semibold text-primary">{% translate "Judging quick launch" %}</div>
                <h1 class="h3 mb-2">{% translate "Start scoring in seconds" %}</h1>
                <p class="mb-0 text-muted">
                    {% translate "Follow the steps below: scan a badge whenever possible and fall back to manual entry only when needed." %}
                </p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-primary btn-lg" id="qr_button">
                    <i class="bi bi-qr-code-scan me-2"></i>{% translate "Launch scanner" %}
                </button>
                <a href="{{ judging_portal_url }}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-lg">
                    <i class="bi bi-speedometer2 me-2"></i>{% translate "Open dashboard" %}
                </a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-primary-subtle text-primary fw-semibold">{% translate "Step 1" %}</span>
                        <h2 class="h5 mb-0">{% translate "Scan a participant badge" %}</h2>
                    </div>
                    <p class="text-muted mb-0">
                        {% translate "Use your phone or the provided handheld scanner. Leave the camera window open between teams for the fastest experience." %}
                    </p>
                    <div class="alert alert-primary d-flex align-items-start gap-3 mb-0" role="status">
                        <i class="bi bi-info-circle-fill fs-5"></i>
                        <div>
                            <div class="fw-semibold">{% translate "Ready when you are" %}</div>
                            <p class="mb-0 small" id="scan-status" data-default-text="{% translate 'Tap “Launch scanner” to enable your camera.' %}">{% translate "Tap “Launch scanner” to enable your camera." %}</p>
                        </div>
                    </div>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item px-0">
                            <i class="bi bi-check-circle text-success me-2"></i>{% translate "Point the camera at the badge QR. The page will redirect automatically." %}
                        </li>
                        <li class="list-group-item px-0">
                            <i class="bi bi-check-circle text-success me-2"></i>{% translate "If your device asks for permission, allow camera access so the scanner can initialise." %}
                        </li>
                        <li class="list-group-item px-0">
                            <i class="bi bi-check-circle text-success me-2"></i>{% translate "Need to rescan? Tap the scanner button again to reopen the camera." %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-secondary-subtle text-secondary fw-semibold">{% translate "Step 2" %}</span>
                        <h2 class="h5 mb-0">{% translate "Enter a code manually" %}</h2>
                    </div>
                    <p class="text-muted mb-0">
                        {% translate "Only use this when the badge isn't scanning. The project will open in the same way." %}
                    </p>
                    <form method="post" id="qr-manual-form" class="d-flex flex-column gap-3">
                        {% csrf_token %}
                        <div>
                            <label class="form-label fw-semibold" for="id_qr_code">{% translate "Badge value" %}</label>
                            <input type="text" id="id_qr_code" name="qr_code" class="form-control form-control-lg" placeholder="ABC123 or https://..." autocomplete="off" inputmode="text" required>
                            <div class="form-text">{% translate "Use the text printed underneath the QR code or the encoded link provided to judges." %}</div>
                        </div>
                        <button type="submit" class="btn btn-success btn-lg w-100">
                            <i class="bi bi-arrow-right-circle me-2"></i>{% translate "Open scoring" %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body d-flex flex-column gap-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-info-subtle text-info fw-semibold">{% translate "Step 3" %}</span>
                        <h2 class="h6 mb-0">{% translate "Keep judging flowing" %}</h2>
                    </div>
                    <p class="mb-0 text-muted">{% translate "After finishing a team, come back here (bookmark it!) to start the next one." %}</p>
                    <div class="alert alert-info mb-0" role="alert">
                        <div class="fw-semibold">{% translate "Need a refresher?" %}</div>
                        <p class="mb-0 small">{% translate "The judges guide covers scoring criteria, conflict of interest rules, and troubleshooting tips." %}</p>
                        <a href="{% url 'event:judges_guide' %}" class="btn btn-outline-info btn-sm mt-2">
                            <i class="bi bi-book me-1"></i>{% translate "Open judges guide" %}
                        </a>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-5 d-flex flex-column gap-3">
            <a href="{% url 'judging:dashboard' %}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-house-door me-2"></i>{% translate "Back to judging dashboard" %}
            </a>
        </div>
    </div>
</div>
<video id="qr-video" style="width: 100%; height: auto; display: none;"></video>
{% endblock %}

{% block scripts %}
    {{ block.super }}
    <script nonce="{{ request.csp_nonce }}">
        document.addEventListener('DOMContentLoaded', function () {
            const scanButton = document.getElementById('qr_button');
            const qrInput = document.getElementById('id_qr_code');
            const manualForm = document.getElementById('qr-manual-form');
            const statusMessage = document.getElementById('scan-status');
            if (!scanButton) {
                return;
            }

            const scanUrlTemplate = "{% url 'judging:scan' 'REPLACE' %}";
            let isProcessing = false;

            if (qrInput) {
                window.setTimeout(() => qrInput.focus({ preventScroll: true }), 150);
            }

            function extractSlug(value) {
                if (!value) {
                    return '';
                }
                let slug = String(value).trim();
                if (!slug) {
                    return '';
                }
                if (slug.includes('://')) {
                    try {
                        const url = new URL(slug);
                        slug = url.searchParams.get('code') || url.pathname.split('/').filter(Boolean).pop() || slug;
                    } catch (err) {
                        const parts = slug.split('/').filter(Boolean);
                        if (parts.length) {
                            slug = parts.pop();
                        }
                    }
                }
                return slug;
            }

            const scanner = new Scanner('qr-video', function (content) {
                if (isProcessing) {
                    return;
                }
                const rawValue = content && typeof content === 'object' ? content.data : content;
                const slug = extractSlug(rawValue);
                if (!slug) {
                    return;
                }
                isProcessing = true;
                scanner.hide();
                if (qrInput) {
                    qrInput.value = slug;
                }
                if (manualForm) {
                    manualForm.submit();
                } else {
                    window.location.href = scanUrlTemplate.replace('REPLACE', encodeURIComponent(slug));
                }
            }, {
                popup: true,
                popup_title: "{{ _('Scan badge')|escapejs }}",
                popup_class: 'bg-{{ theme }}',
            });

            const originalHide = scanner.hide.bind(scanner);
            scanner.hide = function () {
                originalHide();
                if (statusMessage) {
                    statusMessage.textContent = statusMessage.dataset?.defaultText || statusMessage.textContent;
                }
            };

            scanButton.addEventListener('click', function (event) {
                event.preventDefault();
                isProcessing = false;
                scanner.show();
                if (statusMessage) {
                    statusMessage.textContent = "{% translate 'Camera active. Aim at the badge QR to open the project.' %}";
                }
            });

        });
    </script>
{% endblock %}
