{% extends 'base.html' %}
{% load i18n %}

{% block subtitle %}{% translate "Judging" %}{% endblock %}

{% block content %}
<div class="d-flex flex-column gap-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body d-flex flex-column flex-xl-row justify-content-between align-items-start align-items-xl-center gap-4">
            <div class="d-flex flex-column gap-2">
                <div class="text-uppercase small fw-semibold text-primary">{% translate "Judging" %}</div>
                <h1 class="h3 mb-0">{% translate "Judging dashboard" %}</h1>
                <p class="text-muted mb-0">
                    {% translate "Stay on top of assignments, finish evaluations, and be ready when organizers release scores." %}
                </p>
                <div class="d-flex flex-column flex-md-row gap-2 mt-2">
                    <a href="{{ launch_url }}" class="btn btn-primary btn-lg">
                        <i class="bi bi-rocket-takeoff me-2"></i>{% translate "Launch scoring portal" %}
                    </a>
                    <a href="{{ judges_guide_url }}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-lg">
                        <i class="bi bi-book me-2"></i>{% translate "Judges guide" %}
                    </a>
                </div>
            </div>
            <div class="d-flex flex-column gap-2 align-self-stretch align-items-start align-items-xl-end">
                {% if active_window %}
                    <div class="badge bg-success-subtle text-success-emphasis px-3 py-2 rounded-pill">
                        <i class="bi bi-clock-history me-1"></i>{% translate "Active judging window" %}
                    </div>
                    <div class="text-muted small text-xl-end">
                        {{ active_window.opens_at|date:"D H:i" }} — {{ active_window.closes_at|date:"D H:i" }}
                    </div>
                {% else %}
                    <div class="badge bg-warning-subtle text-warning-emphasis px-3 py-2 rounded-pill">
                        <i class="bi bi-hourglass-split me-1"></i>{% translate "Judging window closed" %}
                    </div>
                    <div class="text-muted small">{% translate "Scores are currently read-only." %}</div>
                {% endif %}
                <div class="card border-0 bg-light-subtle mt-3">
                    <div class="card-body py-2 px-3 d-flex flex-column gap-2">
                        <div class="fw-semibold small text-uppercase text-muted">{% translate "Next up" %}</div>
                        <ul class="list-unstyled mb-0 small text-muted d-flex flex-column gap-1">
                            <li><i class="bi bi-check-circle-fill text-success me-1"></i>{% translate "Scan or search for a team" %}</li>
                            <li><i class="bi bi-check-circle-fill text-success me-1"></i>{% translate "Submit your evaluations before the window closes" %}</li>
                            <li><i class="bi bi-check-circle-fill text-success me-1"></i>{% translate "Use the dashboard to monitor your progress" %}</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-3 g-3">
        <div class="col">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="text-uppercase small fw-semibold text-muted">{% translate "Drafts" %}</div>
                    <div class="display-6 fw-bold">{{ summary.drafts }}</div>
                    <p class="mb-0 text-muted">{% translate "Finish these before release." %}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="text-uppercase small fw-semibold text-muted">{% translate "Submitted" %}</div>
                    <div class="display-6 fw-bold">{{ summary.submitted }}</div>
                    <p class="mb-0 text-muted">{% translate "Awaiting release from organizers." %}</p>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="text-uppercase small fw-semibold text-muted">{% translate "Released" %}</div>
                    <div class="display-6 fw-bold">{{ summary.released }}</div>
                    <p class="mb-0 text-muted">{% translate "Final scores published." %}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body d-flex flex-column gap-3">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="h5 mb-0">{% translate "Find a project" %}</h2>
                <span class="text-muted small">{% translate "Use filters to narrow down your assignments." %}</span>
            </div>
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-6">
                    <label class="form-label" for="{{ filter_form.query.id_for_label }}">{{ filter_form.query.label }}</label>
                    {{ filter_form.query }}
                    {% if filter_form.query.errors %}
                        <div class="form-feedback-error" role="alert">{{ filter_form.query.errors|join:', ' }}</div>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <label class="form-label" for="{{ filter_form.track.id_for_label }}">{{ filter_form.track.label }}</label>
                    {{ filter_form.track }}
                    {% if filter_form.track.errors %}
                        <div class="form-feedback-error" role="alert">{{ filter_form.track.errors|join:', ' }}</div>
                    {% endif %}
                </div>
                <div class="col-md-2 d-grid">
                    <button type="submit" class="btn btn-primary">{% translate "Filter" %}</button>
                </div>
            </form>
        </div>
    </div>

    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table align-middle mb-0">
                    <thead>
                        <tr>
                            <th scope="col">{% translate "Project" %}</th>
                            <th scope="col" class="d-none d-md-table-cell">{% translate "Track" %}</th>
                            <th scope="col" class="d-none d-lg-table-cell">{% translate "Table" %}</th>
                            <th scope="col" class="text-center">{% translate "My status" %}</th>
                            <th scope="col" class="text-end">{% translate "Action" %}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in project_rows %}
                            {% with project=row.project evaluation=row.evaluation %}
                            <tr>
                                <td class="fw-semibold">{{ project.name }}</td>
                                <td class="text-muted d-none d-md-table-cell">{{ project.track|default:_('TBD') }}</td>
                                <td class="text-muted d-none d-lg-table-cell">{{ project.table_location|default:'—' }}</td>
                                <td class="text-center">
                                    {% if evaluation %}
                                        {% if evaluation.status == 'submitted' %}
                                            <span class="badge bg-primary-subtle text-primary-emphasis px-3 py-2">{% translate "Submitted" %}</span>
                                        {% elif evaluation.status == 'released' %}
                                            <span class="badge bg-success-subtle text-success-emphasis px-3 py-2">{% translate "Released" %}</span>
                                        {% else %}
                                            <span class="badge bg-warning-subtle text-warning-emphasis px-3 py-2">{% translate "Draft" %}</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-secondary-subtle text-secondary-emphasis px-3 py-2">{% translate "Not started" %}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <a href="{% url 'judging:score' project.pk %}" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-box-arrow-up-right me-1"></i>{% translate "Open scoring" %}
                                    </a>
                                </td>
                            </tr>
                            {% endwith %}
                        {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">{% translate "No projects available right now." %}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
